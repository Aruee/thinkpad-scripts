#!/bin/bash

# Script orignally from http://forum.thinkpads.com/viewtopic.php?p=676101#p676101.
# Changes Copyright Â© 2012-2013 Martin Ueding <dev@martin-ueding.de>

set -e

TEXTDOMAIN=think-rotate

for import in kdialog.sh
do
	for dir in lib /usr/share/think-rotate
	do
		importfile="$dir/$import"
		if [[ -f "$importfile" ]]
		then
			. "$importfile"
		fi
	done
done

trap kdialog-exit EXIT

###############################################################################
#                                   options                                   #
###############################################################################

# The name of the internal display.
internal="LVDS1"

# The name of the virtual keyboard.
virtual_kbd="kvkbd"

# Now import the configuration file if there is one. That will replace any
# options set above.
configfile="$HOME/.config/think-rotate/rotate.sh"

prerotate_hook="$HOME/.config/think-rotate/hooks/prerotate"
postrotate_hook="$HOME/.config/think-rotate/hooks/postrotate"

if [[ -f "$configfile" ]]
then
	source "$configfile"
fi

kdialog-init $"think-rotate" 8

kdialog-update $"Reading config file"

kdialog-update $"Executing pre-hooks"
if [[ -f "$prerotate_hook" ]]
then
    "$prerotate_hook"
fi

###############################################################################
#                               current status                                #
###############################################################################

kdialog-update $"Finding current rotation"

# Find the line in ``xrandr -q --verbose`` output that contains current screen
# orientation and strip out current orientation.
rotation="$(xrandr -q --verbose | grep 'connected' | grep "$internal" | egrep -o  '\) (normal|left|inverted|right) \(' | egrep -o '(normal|left|inverted|right)')"

echo $"Current status is $rotation."

###############################################################################
#                                new rotation                                 #
###############################################################################

kdialog-update $"Infering new rotation"

# If the user specified a rotation, set it to that. If not, use left or default
# orientation.
if [[ -n "$1" ]]
then
	# The users specified a rotation. Set the screen to that state if the
	# current state is not the desired one. If the desired one is the current,
	# go back. This allows to toggle with the same call.
	if [[ "$1" = "$rotation" ]]
	then
		echo $"You try to rotate into the direction it is, reverting to normal."
		setto=normal
	else
		setto="$1"
		echo $"User chose to set to $setto."
	fi
else
	# The user did not specify anything. Set it to right or revert.
	case "$rotation" in
		normal)
			setto=right
			echo $"Using default, setting to $setto."
			;;
		*)
			setto=normal
			echo $"Using default, reverting to normal."
	esac
fi

# Translate directions into ``xrandr`` and ``xsetwacom`` names.
case "$setto" in
	none|normal)
		xrandr_rotation=normal
		wacom_rotation=none
		;;
	cw|right)
		xrandr_rotation=right
		wacom_rotation=cw
		;;
	half|inverted|flip)
		xrandr_rotation=inverted
		wacom_rotation=half
		;;
	ccw|left)
		xrandr_rotation=left
		wacom_rotation=ccw
		;;
	*)
		echo $"You specified a direction that is not known. Try either normal, right, flip or left. See think-rotate(1) for more information."
		exit 2
esac

# Perform the actual rotation.
kdialog-update $"Rotating screen"
xrandr --output "$internal" --rotate "$xrandr_rotation"

# Rotate the Wacom devices.
echo $"Rotating Wacom devices to $wacom_rotation."

kdialog-update $"Rotating Wacom devices"

xsetwacom list devices | grep 'Wacom ISD' | sed 's/id: .*//' | while read device
do
	xsetwacom set "$device" rotate "$wacom_rotation"
	xsetwacom set "$device" MapToOutput "$internal"
done

###############################################################################
#                              virtual keyboard                               #
###############################################################################

kdialog-update $"Starting or killing virtual keyboard"

# Start the virtual keyboard, if it is installed.
if type "$virtual_kbd" &> /dev/null
then
	if [[ "$setto" = "normal" ]]
	then
		# So the user reverts back to normal. Kill the virtual keyboard (if it
		# is running), since it does not make any sense to use that any more.
		if pgrep "$virtual_kbd" &> /dev/null
		then
			killall "$virtual_kbd"
		fi
	else
		# The user rotated the screen. Start the virtual keyboard since he
		# might need it.
		"$virtual_kbd" &> /dev/null &
	fi
fi

###############################################################################
#                           TrackPoint and TouchPad                           #
###############################################################################

kdialog-update $"Enabling/Disabling TrackPoint and TouchPad"

# Enable and disable the TrackPoint. First, find the id of the TrackPoint.
trackpoint_id="$(xinput list | grep TrackPoint | grep --only-matching -P 'id=(\d+)' | cut -c 4-)"
touchpad_id="$(xinput list | grep TouchPad | grep --only-matching -P 'id=(\d+)' | cut -c 4-)"

# Set the mode to which the input devices should be set.
if [[ "$setto" = "normal" ]]
then
	input_to=1
else
	input_to=0
fi

for device in "$trackpoint_id" "$touchpad_id"
do
	echo $"Toggling input device $device to $input_to."
	xinput set-prop "$device" "Device Enabled" "$input_to"
done

kdialog-update $"Executing post-hooks"
if [[ -f "$postrotate_hook" ]]
then
    "$postrotate_hook"
fi
