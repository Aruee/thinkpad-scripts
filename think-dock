#!/bin/bash
# Copyright © 2012 Martin Ueding <dev@martin-ueding.de>

# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the Free
# Software Foundation, either version 2 of the License, or (at your option)
# any later version.

# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
# more details.

# You should have received a copy of the GNU General Public License along with
# this program. If not, see http://www.gnu.org/licenses/.

set -e
set -u

internal="LVDS1"

# Dynamically find the external display by searching for connected displays
# that are not the internal one. If there is no external display connected,
# this will fail and cause the whole script to fail.
external=$(xrandr | grep -Eo '(\S+) connected' | grep -Eo '^(\S+)' | grep -v
"$internal")

echo "External display $external found."

if [[ -z "${1:-}" ]]
then
	echo "usage: think-dock on|off"
	echo "See “man think-dock” for more details."
	exit 2
fi

case "$1" in
	on)
		# Set the screens to the right setting.
		xrandr --output "$internal" --auto
		xrandr --output "$external" --auto --right-of "$internal" --primary
		;;
	off)
		# Disable the external screen and make the internal the primary again.
		xrandr --output "$internal" --auto --primary
		xrandr --output "$external" --off
		;;
esac

# Set the Wacom devices to the internal screen. If this is not done, they are
# streched out over both screens which makes no sense.
for device in "Wacom ISDv4 E6 Pen stylus" "Wacom ISDv4 E6 Finger touch" "Wacom ISDv4 E6 Pen eraser"
do
	xsetwacom set "$device" MapToOutput "$internal"
done
